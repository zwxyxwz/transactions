# Multi-Version Concurrency Control (MVCC) 详解

## Context

MVCC，全称为多版本并发控制，是一种在数据库系统中用于管理并发操作的技术。它的核心思想是允许多个版本的数据记录同时存在，从而减少事务之间的冲突，提高并发性能。

![mvcc](https://d5xi0cqy9xfw87.archive.is/lSNMu/cbdfb0bffbc1ff25df22dc6685a60184a873d3f9.webp)

### 工作原理

1. 允许多个事务同时访问相同的数据而不相互干扰。
2. 为相同的数据对象创建多个版本，并允许事务同时访问不同的版本。通过这种方式，事务可以读取数据而不会相互阻塞，写入操作也可以在不引起冲突或不一致的情况下执行。

### 具体步骤

1. 当一个事务想要读取或写入数据时，它首先检查系统事务表以确定是否可以继续。如果事务可以继续，它将被分配一个唯一的事务 ID。
2. 当事务写入数据对象时，将创建该对象的新版本，并将事务 ID 与该版本关联。新版本将被添加到系统版本表中。
3. 当事务读取数据对象时，它会在版本表中搜索该对象在事务开始时间之前创建的最新版本。事务将从该版本的对象中读取。
4. 数据对象的每个版本都与事务 ID、开始时间和结束时间相关联。开始时间是版本创建的时间，结束时间是该版本被新版本取代的时间。
5. 当事务提交时，其结束时间将被记录在事务表中。与该事务关联的所有数据对象版本将被标记为已提交，它们的结束时间将设置为事务的结束时间。
6. 当事务回滚时，其结束时间将被记录在事务表中。与该事务关联的所有数据对象版本将被标记为已回滚，它们的结束时间将设置为事务的结束时间。
7. 当新事务开始时，它只能访问在其开始时间之前已提交的数据对象。这确保了事务只读取一致的数据。

### 常规能力
1. **版本创建** ：每当一个事务对数据进行更新或删除操作时，MVCC 会创建一个新的数据版本，而不是直接修改原来的记录。每个版本都带有时间戳或事务 ID，用于标识其创建时间。
2. **读写分离** ：读操作和写操作可以同时进行，而不会互相阻塞。读操作读取的是数据的某个历史版本，而写操作创建新的版本。这样，读事务不会被写事务阻塞，写事务也不会被读事务阻塞。
3. **垃圾回收** ：随着时间的推移，旧的版本数据需要被清理，以节省存储空间。MVCC 通过垃圾回收机制来自动删除不再需要的旧版本。

## 优势

1. **高并发性能** ：由于读写操作不互相阻塞，MVCC 能够显著提高数据库在高并发场景下的性能。写事务可以在不影响读事务的情况下进行，反之亦然。
2. **减少锁竞争** ：传统的锁机制容易导致事务之间的相互等待和死锁问题。MVCC 通过多版本控制避免了大部分锁的使用，从而减少了锁竞争。
3. **数据一致性** ：MVCC 能够保证事务在读取数据时看到一致的数据视图（snapshot），避免了脏读、不可重复读和幻读等问题。
4. **事务之间高度隔离**：每个事务读取自己的一份数据视图。

## 劣势

1. **存储开销** ：MVCC 需要存储多个版本的数据，这会导致存储空间的增加。在数据更新频繁且版本数量较多的情况下，存储开销可能变得显著。
2. **垃圾回收复杂性** ：垃圾回收机制需要定期清理旧版本数据，但如果没有合理的设计，这一过程可能会对数据库性能产生一定的影响。
3. **查询复杂性** ：在某些情况下，查询可能需要检查多个版本的数据来获取最新的有效版本，这会增加查询的复杂性和潜在的性能开销。

## 适用场景

| 适用场景 | 说明 |
| --- | --- |
| 高并发读密集型应用 | 如电子商务网站、社交媒体平台，这些应用场景中读操作远多于写操作，MVCC 能够允许读操作快速进行，而不被写操作阻塞。 |
| 需要数据一致性的场景 | 在数据仓库和分析系统中，通常需要对数据进行长时间的查询和分析，MVCC 可以确保在查询过程中数据的一致性。 |
| 长事务 | 对于一些需要长时间运行的事务，MVCC 可以避免这些事务与其他事务之间的冲突，确保它们能够顺利完成。 |
| 高并发事务 | TODO |
| 高度隔离事务 | 财务或支付相关应用 |

## 挑战与解决方案

> **垃圾回收** ：旧版本数据的清理是一个挑战。如果垃圾回收不及时，可能会导致存储空间的浪费；如果过于频繁，又可能会影响数据库的性能。
- 定期运行垃圾回收任务，并且可以采用分区策略，将不同时间段的数据存储在不同的分区中，以便更高效地进行垃圾回收。此外，一些数据库系统会根据数据的访问频率和事务的完成情况来动态调整垃圾回收的策略。

> **版本存储开销** ：随着数据的不断更新和版本的不断增加，存储开销可能会变得很大。
- 可以通过合理设置数据的生命周期策略，及时删除过期的版本数据。
- 可以采用数据压缩技术来减少版本数据的存储空间。一些数据库还支持将旧版本数据归档到低成本的存储介质中，以降低存储成本。

> **写偏移** ：在高写入负载的情况下，新的版本数据可能会不断产生，导致读操作看到的都是较旧的数据版本，从而出现写偏移问题，影响数据的实时性。
- 可以通过调整数据库的参数，如增加内存缓存、优化磁盘 I/O 等，来提高写入性能。
- 可以采用读写分离的架构，将读操作和写操作分配到不同的服务器或节点上，减轻单个节点的写入压力。

> **版本冲突** ：在某些情况下，多个事务可能会对同一个数据记录进行频繁的更新，导致版本冲突。
- 可以采用乐观锁或悲观锁机制来处理版本冲突。乐观锁会在事务提交时检查数据版本是否被其他事务修改，如果修改则回滚事务并重新执行；悲观锁则会在事务开始时就对数据进行加锁，防止其他事务进行修改。
- 此外，也可以通过业务逻辑的设计来尽量避免频繁更新同一个数据记录的情况。